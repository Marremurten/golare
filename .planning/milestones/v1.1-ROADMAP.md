# Milestone v1.1: AI Behavioral Awareness

**Status:** ✅ SHIPPED 2026-02-12
**Phases:** 1-5
**Total Plans:** 8

## Overview

Make Guzman reactive to real player behavior — tracking what players write in group chat and using that data to personalize whispers, adapt narratives, and call out suspicious behavior.

## Phases

### Phase 1: Data Pipeline

**Goal**: Player group messages are captured, stored in a ring buffer (last ~10 per player), and the bot verifies admin status for message visibility — all without any user-facing changes.
**Depends on**: Nothing (first phase)
**Plans**: 2 plans

Plans:
- [x] 01-01: Database schema, types, and CRUD for player_messages ring buffer
- [x] 01-02: Message capture module, bot middleware wiring, and admin check

**Details:**
- player_messages table with UUID PK, game_id/game_player_id FKs (CASCADE), composite index
- PostgreSQL ring buffer: prune_player_messages() trigger keeps last 10 per player per game
- Fire-and-forget middleware pattern with DATA-03 filtering (bots, commands, non-players)
- In-memory game ID cache with 5-min TTL + explicit invalidation at all state transitions
- Bot admin check at /nyttspel (DATA-04)

### Phase 2: Behavioral Analysis

**Goal**: A behavioral analysis module computes per-player activity stats and tone classifications, builds compressed summaries that populate `GuzmanContext.playerNotes`, and detects behavioral anomalies — still no user-facing changes.
**Depends on**: Phase 1
**Plans**: 1 plan

Plans:
- [x] 02-01: Behavioral analysis module (stats, tone, anomalies, summaries) and integration into updateNarrativeContext

**Details:**
- Pure functions: computePlayerStats, classifyTone, detectAnomalies, buildPlayerSummary
- Heuristic Swedish keyword tone classification (anklagande, defensiv, tyst, neutral, kaotisk)
- Self-relative anomaly detection (player vs own history across rounds)
- Structured label format (~50 tokens/player, 200-char hard cap)
- Non-critical: failure never blocks game loop (CONST-04)

### Phase 3: Whisper Integration

**Goal**: Guzman's whisper DMs reference actual player behavior — paraphrasing what players said (twisted, out of context), including behavioral summaries for all players, with prompt rules enforcing oblique references only.
**Depends on**: Phase 2
**Plans**: 2 plans

Plans:
- [x] 03-01: Behavioral data helpers and behavior-aware whisper prompt rewrite
- [x] 03-02: AI generation wiring and whisper handler integration

**Details:**
- selectQuotesForWhisper: signal-scored message selection using TONE_KEYWORDS
- buildAllPlayerOverview: compressed multi-player summary (500-char cap)
- Gossip-dealer persona (skvallerkung) with oblique-reference rules (WHISP-03)
- Role-aware paranoia calibration (aggressive/seductive/respectful per PlayerRole)
- Round-based intensity escalation: vague (1-2), specific (3), pointed (4-5)
- FORSAKRAN as 4th whisper strategy (trust/reassurance as manipulation)
- Verbatim safety check: 8-char threshold with single retry (CONST-04)

### Phase 4: Gap-Fill & Accusations

**Goal**: Gap-fill commentary adapts to group mood, and Guzman publicly calls out suspicious behavior (silence, aggression spikes) with controlled frequency — making the group chat feel like Guzman is always watching.
**Depends on**: Phase 3
**Plans**: 2 plans

Plans:
- [x] 04-01: Group mood computation, accusation target selection, prompt builders, and generateAccusation
- [x] 04-02: Accusation delivery, frequency tracking, and mood-adaptive gap-fill wiring in whisper-handler

**Details:**
- GroupMood type (tense/active/calm) computed at runtime from playerNotes
- selectAccusationTarget with anomaly-based selection and last-target exclusion
- Null fallback for accusations (never fabricates on AI failure)
- Flat max 2 accusations per round (locked user decision, no escalation)
- Mood-adaptive gap-fill gating: tense=always, calm=never, active=when quiet
- Accusation fires skip gap-fill for that slot (no double messages)
- Fresh analyzeBehavior at cron time (not stale playerNotes)

### Phase 5: Mission Adaptation

**Goal**: Mission narratives include a group dynamics section that reflects recent player behavior patterns, making each mission post feel tailored to the current game atmosphere.
**Depends on**: Phase 2
**Plans**: 1 plan

Plans:
- [x] 05-01: Behavior-aware mission prompt, AI generator wiring, and fresh behavioral data in onMissionPost

**Details:**
- buildMissionPrompt expanded with groupDynamics and groupMood params
- Soft mood-to-theme mapping: tense=betrayal, calm=urgency, active=complexity
- GRUPPDYNAMIK-REGLER section: behavioral labels translated to natural Guzman voice
- 70/30 split rule: 70% mission content, 30% max group dynamics
- Behavioral data hard-capped at 500 chars (CONST-02)

---

## Milestone Summary

**Key Decisions:**
- Zero new dependencies: existing stack covers all needs (CONST-01)
- Heuristic-first tone analysis: cheaper and more reliable than Swedish NLP for orten-slang
- Compressed summaries, not raw messages: 2x token budget vs 5x with raw (CONST-02)
- Accusations piggyback on gap-fill: reuses existing scheduler, no new cron jobs
- playerNotes as integration seam: already in GuzmanContext, already read by whisper prompts
- Fire-and-forget message capture: storage never blocks handler chain
- Ring buffer pruning via PostgreSQL trigger (not application code)
- Round-based whisper escalation: solves thin-data problem and creates narrative arc
- FORSAKRAN as 4th whisper strategy: trust as manipulation
- Null fallback for accusations: never fabricates on AI failure
- Flat max 2 accusations per round (user decision override of spec's "1 per 4-hour window")

**Issues Resolved:**
- Thin behavioral data in early rounds resolved via round-based escalation (vague early, pointed late)
- Verbatim quote leakage prevented via post-generation safety check with 8-char threshold
- GROUP-03 spec vs implementation deviation documented and accepted (max 2/round vs max 1/4hr)

**Issues Deferred:**
- In-memory Maps for accusation tracking / whisper state (lost on restart) — inherited v1 debt
- Global mutable `let botRef` for scheduler-handler bridge — inherited v1 debt

**Technical Debt Incurred:**
- In-memory accusation tracking Map (not persisted — lost on restart)
- Default "active" mood hardcoded as fallback when behavioral data unavailable

---

_For current project status, see .planning/PROJECT.md_
