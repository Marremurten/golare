---
phase: 02-game-lobby
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/lib/roles.ts
  - src/lib/messages.ts
  - src/handlers/lobby.ts
  - src/handlers/game-commands.ts
autonomous: true

must_haves:
  truths:
    - "After game start, each player receives a private DM revealing their secret role with Guzman voice"
    - "Golare receive a DM listing all other Golare identities by name"
    - "H칬gra Hand receives a DM confirming their Spaning ability"
    - "Role distribution matches the balancing table (~25% Golare, 1 H칬gra Hand from 츿kta pool)"
    - "All role DMs are sent simultaneously (no staggering)"
    - "A dramatic Guzman monologue is posted to the group when game starts"
    - "Admin can cancel the game at any point with /avbryt"
  artifacts:
    - path: "src/lib/roles.ts"
      provides: "Role assignment engine with Fisher-Yates shuffle and balancing table"
      exports: ["assignRoles", "ROLE_BALANCING"]
      contains: "crypto"
    - path: "src/lib/messages.ts"
      provides: "Role reveal templates and game start monologue"
      contains: "ROLE_REVEAL"
    - path: "src/handlers/lobby.ts"
      provides: "Updated start callback that assigns roles and sends DMs"
      contains: "assignRoles"
    - path: "src/handlers/game-commands.ts"
      provides: "/avbryt command handler"
      exports: ["gameCommandsHandler"]
  key_links:
    - from: "src/handlers/lobby.ts"
      to: "src/lib/roles.ts"
      via: "assignRoles called in start callback"
      pattern: "assignRoles"
    - from: "src/handlers/lobby.ts"
      to: "src/queue/message-queue.ts"
      via: "getMessageQueue for role DMs and group monologue"
      pattern: "getMessageQueue"
    - from: "src/handlers/lobby.ts"
      to: "src/db/client.ts"
      via: "updateGame to save roles, team_size"
      pattern: "updateGame"
---

<objective>
Build the role assignment engine and integrate it into the game start flow: when admin clicks "K칬r ig친ng!", assign roles per the balancing table, send dramatic role reveal DMs to all players simultaneously, post a Guzman monologue to the group, and provide /avbryt for game cancellation.

Purpose: This delivers the core "secret identity" mechanic -- the dramatic moment that defines social deduction games.
Output: Complete game start sequence: role assignment, DM delivery, group announcement. Plus /avbryt for cancellation.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-game-lobby/02-RESEARCH.md
@.planning/phases/02-game-lobby/02-01-SUMMARY.md

@src/db/types.ts
@src/db/client.ts
@src/handlers/lobby.ts
@src/lib/messages.ts
@src/queue/message-queue.ts
@src/bot.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Role assignment engine and role reveal message templates</name>
  <files>
    src/lib/roles.ts
    src/lib/messages.ts
  </files>
  <action>
**roles.ts** -- Create new file.

Import `randomInt` from `node:crypto`.

Define the balancing table as a constant:
```
ROLE_BALANCING: Record<number, { golare: number; akta: number; teamSize: number }>
```
Values (from PROJECT.md):
- 4: { golare: 1, akta: 3, teamSize: 2 }
- 5: { golare: 1, akta: 4, teamSize: 2 }
- 6: { golare: 2, akta: 4, teamSize: 3 }
- 7: { golare: 2, akta: 5, teamSize: 3 }
- 8: { golare: 2, akta: 6, teamSize: 3 }
- 9: { golare: 3, akta: 6, teamSize: 4 }
- 10: { golare: 3, akta: 7, teamSize: 4 }

Export ROLE_BALANCING for use in other modules (team_size needed at game start).

Implement `cryptoShuffle<T>(array: T[]): T[]` -- Fisher-Yates shuffle using `randomInt(0, i + 1)`. Returns a new shuffled array (does NOT mutate input).

Define return type:
```typescript
import type { PlayerRole } from "../db/types.js";

type RoleAssignment = {
  playerId: string;
  role: PlayerRole;
};
```

Implement `assignRoles(playerIds: string[]): RoleAssignment[]`:
1. Look up balancing for playerIds.length. Throw Error if count not in 4-10.
2. Shuffle player IDs with cryptoShuffle.
3. First N = golare count are Golare.
4. Remaining are 츿kta pool.
5. Pick one random 츿kta as H칬gra Hand using randomInt(0, aktaPool.length).
6. Return array of RoleAssignment objects mapping each playerId to their role.

Export: assignRoles, ROLE_BALANCING, RoleAssignment type.

**messages.ts** -- Add role reveal and game start templates to existing MESSAGES object:

Role reveal DMs (full Guzman voice, dramatic, in-character suburb slang per user decision):

- `ROLE_REVEAL_AKTA: string` -- Full brief for 츿kta role. Must include: role name ("츿kta"), team ("Ligan"), goal (genomf칬ra st칬tar), win condition (3 lyckade st칬tar), reminder to trust no one. Guzman voice, dramatic, personal. Example tone: "Yo bre, lyssna noga... Du 칛r 츿KTA. Du tillh칬r Ligan -- vi 칛r familjen..."

- `ROLE_REVEAL_GOLARE: (otherGolare: string) => string` -- Full brief for Golare role. Must include: role name ("Golare"), team ("Aina"), goal (sabotera st칬tar), win condition (3 saboterade st칬tar), the list of other Golare identities (per user decision: "Dina br칬der i skiten: @erik, @lisa"). When only one Golare in game (4-5 players), adjust text to "Du 칛r ensam, bre. Ingen annan Golare." Guzman voice.

- `ROLE_REVEAL_HOGRA_HAND: string` -- Full brief for H칬gra Hand role. Must include: role name ("Guzmans H칬gra Hand"), team ("Ligan / 츿kta"), special ability ("Spaning" -- can check one player's true role once during the game), goal (help Ligan win + stay hidden from Golare), warning about being targeted. Guzman voice, make the player feel trusted and important.

- `GAME_START_MONOLOGUE: string` -- Dramatic group message when game starts. Guzman in full character addressing the group. Must include: (1) dramatic setup ("n친nting luktar fisk..."), (2) brief rules weaved in naturally (not a wall of text per user decision), (3) warning about Golare among them, (4) mood setting for the game. Keep it to 6-10 lines -- impactful but not overwhelming. Use HTML formatting (<b>bold</b> for emphasis) with parse_mode: "HTML".

- `GAME_CANCELLED: (adminName: string) => string` -- Guzman announces game cancellation. Brief, in character. Example: "{adminName} drog i n칬dbromsen. Spelet 칛r avbrutet, bre. 游뛂"

- `GAME_CANCEL_CONFIRM: string` -- answerCallbackQuery text confirming cancellation for admin.

All Swedish text MUST use proper 친칛칬/칀츿칐 characters.
  </action>
  <verify>
Run `npx tsc --noEmit` -- zero errors. Verify roles.ts exports assignRoles and ROLE_BALANCING. Test mentally: assignRoles(["a","b","c","d"]) with 4 players should produce 1 golare, 2 akta, 1 hogra_hand. Verify all Swedish templates use proper 친칛칬.
  </verify>
  <done>
Role assignment engine produces correct distribution for all player counts 4-10. All role reveal DMs are in full Guzman voice with complete role briefs. Golare DM includes list of other Golare. H칬gra Hand DM confirms Spaning ability. Game start monologue is dramatic and weaves in rules naturally.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire role assignment into game start flow, add /avbryt command</name>
  <files>
    src/handlers/lobby.ts
    src/handlers/game-commands.ts
    src/bot.ts
  </files>
  <action>
**lobby.ts** -- Update the existing `start:{gameId}` callback handler (from Plan 01):

After the state transition to "active" and lobby message edit, add the game start sequence:

1. Import assignRoles and ROLE_BALANCING from "../lib/roles.js".
2. Get players with full info: getGamePlayersWithInfo(gameId).
3. Assign roles: `const assignments = assignRoles(playerIds)` where playerIds is array of player UUIDs.
4. Get team_size from ROLE_BALANCING[players.length] and update game: `updateGame(gameId, { state: "active", team_size: balancing.teamSize })`.
5. Save roles to database: For each assignment, update the game_player row with the assigned role. Add a helper function or use a loop calling supabase update on game_players where game_id AND player_id. Alternatively, add a `setPlayerRole(game_id, player_id, role)` function to client.ts if needed.
6. Build a map of playerId -> display name (use @username if available, else first_name, else "Ok칛nd") for the Golare identity list.
7. Build a map of playerId -> dm_chat_id from the player info.
8. Send role DMs simultaneously via Promise.all (per user decision "all role DMs sent simultaneously"):
   - For each assignment, determine the DM text based on role:
     - "akta" -> MESSAGES.ROLE_REVEAL_AKTA
     - "golare" -> MESSAGES.ROLE_REVEAL_GOLARE(otherGolareNames) where otherGolareNames is a comma-separated string of other Golare display names
     - "hogra_hand" -> MESSAGES.ROLE_REVEAL_HOGRA_HAND
   - Send via getMessageQueue().send(dmChatId, text, { parse_mode: "HTML" })
   - Each DM goes to a different chat (player's DM), so they queue in separate lanes and process concurrently.
9. Send group monologue: getMessageQueue().send(game.group_chat_id, MESSAGES.GAME_START_MONOLOGUE, { parse_mode: "HTML" }).
10. Wrap everything in try/catch. On failure, log the error. Do NOT revert the game state on partial failure (DMs may have been sent to some players) -- log which DMs failed for debugging.

If a `setPlayerRole` helper is needed in client.ts, add it:
`setPlayerRole(game_id: string, player_id: string, role: PlayerRole): Promise<void>` -- update game_players set role = X where game_id AND player_id.

**game-commands.ts** -- Create new file. Export `gameCommandsHandler` as a `new Composer()`.

/avbryt command:
1. Filter to group/supergroup: `gameCommandsHandler.chatType(["group", "supergroup"]).command("avbryt", ...)`
2. Guard: ctx.from must exist.
3. Get active game: getActiveGame(ctx.chat.id). If none, reply with MESSAGES.LOBBY_NO_GAME. Return.
4. Check permission: verify ctx.from.id === game.admin_user_id. If not, reply "Bara den som skapade spelet kan avbryta det, bre. 游뛂". Return.
5. Update game state: updateGame(game.id, { state: "cancelled" }).
6. If game has lobby_message_id and state was "lobby", try to edit the lobby message to remove buttons: ctx.api.editMessageText(ctx.chat.id, game.lobby_message_id, "Spelet avbr칬ts. 游뛂"). Catch and ignore errors (message may have been deleted).
7. Send cancellation announcement to group via MessageQueue: MESSAGES.GAME_CANCELLED(ctx.from.first_name || ctx.from.username || "Admin").
8. Log: console.log(`[game-commands] Game ${game.id} cancelled by user ${ctx.from.id}`).

**bot.ts** -- Add import and registration:
- `import { gameCommandsHandler } from "./handlers/game-commands.js";`
- `bot.use(gameCommandsHandler);` -- Register AFTER lobbyHandler.
  </action>
  <verify>
Run `npx tsc --noEmit` -- zero errors. Verify lobby.ts imports assignRoles. Verify game-commands.ts exports gameCommandsHandler. Verify bot.ts registers gameCommandsHandler. Verify role DMs use Promise.all (not sequential). Verify all Swedish text uses proper 친칛칬.
  </verify>
  <done>
Game start callback assigns roles per balancing table, saves to DB, sends simultaneous role DMs (츿kta brief, Golare with other Golare names, H칬gra Hand with Spaning confirmation), and posts dramatic Guzman monologue to group. /avbryt command cancels the game and cleans up. Both handlers registered in bot.ts.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. Role assignment: 6 players -> 2 golare, 3 akta, 1 hogra_hand (total 6)
3. Golare DMs include other Golare names
4. H칬gra Hand DM mentions Spaning ability
5. DMs sent via Promise.all (simultaneous, not staggered)
6. Group monologue uses HTML parse_mode
7. /avbryt transitions game to cancelled state
8. All Swedish text uses proper 친칛칬/칀츿칐 characters
</verification>

<success_criteria>
- Role assignment produces correct distribution for 4-10 players per balancing table
- All players receive role-specific DMs simultaneously after game start
- Golare players know each other's identities
- H칬gra Hand player knows about their Spaning ability
- Dramatic Guzman monologue posted to group at game start
- Admin can cancel game at any point with /avbryt
- Cancelled game cleans up lobby message and announces in group
</success_criteria>

<output>
After completion, create `.planning/phases/02-game-lobby/02-02-SUMMARY.md`
</output>
