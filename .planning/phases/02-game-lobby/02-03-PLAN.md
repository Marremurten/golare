---
phase: 02-game-lobby
plan: 03
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/handlers/game-commands.ts
  - src/handlers/start.ts
  - src/lib/messages.ts
autonomous: true

must_haves:
  truths:
    - "Any player can type /regler and get a paginated rules overview with Guzman flavor"
    - "/regler is paginated with inline buttons for Roller, Spelg친ng, and Vinst sections"
    - "Any player can type /status and see current game state (score, round, player list)"
    - "/status in DM shows extra info (player's own role and abilities)"
    - "Both /regler and /status work in group chat AND private DM"
    - "The Phase 1 placeholder show_rules callback is replaced with real /regler"
  artifacts:
    - path: "src/handlers/game-commands.ts"
      provides: "/regler and /status command handlers with paginated inline buttons"
      contains: "regler"
    - path: "src/handlers/start.ts"
      provides: "Updated show_rules callback that redirects to /regler behavior"
      contains: "rules:"
    - path: "src/lib/messages.ts"
      provides: "Rules page templates and status template"
      contains: "RULES_PAGE"
  key_links:
    - from: "src/handlers/game-commands.ts"
      to: "src/db/client.ts"
      via: "getActiveGame, getGamePlayers for /status data"
      pattern: "getActiveGame"
    - from: "src/handlers/game-commands.ts"
      to: "src/lib/messages.ts"
      via: "MESSAGES.RULES_PAGE, MESSAGES.STATUS_*"
      pattern: "MESSAGES\\.(RULES|STATUS)"
    - from: "src/handlers/start.ts"
      to: "rules: callback data"
      via: "Updated show_rules to use rules:roller pattern"
      pattern: "rules:"
---

<objective>
Build the /regler and /status commands: paginated rules with inline navigation buttons (Roller/Spelg친ng/Vinst) and game status showing score, round, and player list. Replace the Phase 1 placeholder rules callback with real functionality.

Purpose: Players need ongoing access to rules and game state at any time. These commands are the information backbone of the game.
Output: Working /regler with 3 paginated sections and /status with game state display. Both work in group chat and DM.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-game-lobby/02-RESEARCH.md
@.planning/phases/02-game-lobby/02-01-SUMMARY.md

@src/handlers/game-commands.ts
@src/handlers/start.ts
@src/lib/messages.ts
@src/db/client.ts
@src/db/types.ts
@src/bot.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rules page templates and status template</name>
  <files>
    src/lib/messages.ts
  </files>
  <action>
Add the following templates to the existing MESSAGES object in messages.ts. All in HTML format (parse_mode: "HTML") with Guzman flavor. Use proper 친칛칬/칀츿칐 characters.

**RULES_PAGE_ROLLER: string** -- "Roller" section covering the three roles:
- <b>츿kta</b> -- Ligans lojala medlemmar. Genomf칬r st칬tar f칬r att h친lla verksamheten ig친ng.
- <b>Golare</b> -- Infiltrat칬rer som jobbar med Aina. Vet vilka de andra Golare 칛r. Saboterar st칬tar inifr친n.
- <b>Guzmans H칬gra Hand</b> -- En av de 츿kta med specialf칬rm친ga "Spaning" (kan kolla en spelares riktiga roll en g친ng under spelet). M친ste h친lla sig dold.
- Keep it concise with Guzman voice headers. Example header: "<b>游꿠 Rollerna i Ligan</b>"
- Weave in brief context about teams (Ligan vs Aina).

**RULES_PAGE_SPELGANG: string** -- "Spelg친ng" section covering game flow:
- The daily cycle: St칬t (mission), Capo-val (team nomination), R칬stning (vote), Utf칬rande (execution), Resultat (reveal).
- Explain briefly what happens at each step. Include times (09:00, 12:00, 15:00, 18:00, 21:00).
- Mention the Kaos-m칛taren (3 NEJ -> auto-fail).
- Keep concise, Guzman voice.

**RULES_PAGE_VINST: string** -- "Vinst" section covering win conditions:
- Ligan wins: 3 lyckade st칬tar (inga Gola-r칬ster).
- Aina wins: 3 saboterade st칬tar (minst en Gola-r칬st).
- Sista Chansen: explain both scenarios (Ligan wins -> Golare guess H칬gra Hand; Golare wins -> 츿kta guess a Golare).
- Brief, dramatic, Guzman voice.

**RULES_PAGE: (page: "roller" | "spelgang" | "vinst") => string** -- Function that returns the appropriate page content. Switch on page parameter.

**STATUS_TEXT: (data: { liganScore: number, ainaScore: number, round: number, totalRounds: number, state: string, players: Array<{ name: string, isCapo?: boolean }>, capo?: string }) => string** -- Group/general status display.
Format:
```
<b>游늵 Spelstatus</b>

<b>St칛llning:</b> Ligan {liganScore} - {ainaScore} Aina
<b>Runda:</b> {round}/{totalRounds}
<b>Fas:</b> {state display name}

<b>Spelare ({count}):</b>
{player list, each on own line, Capo marked with 游녬}
```
If no active game, show "Inget aktivt spel just nu, bre."

**STATUS_DM_EXTRA: (role: string, abilities: string) => string** -- Extra info shown in DM /status:
Format: "\n\n<b>游 Din roll:</b> {role}\n<b>F칬rm친gor:</b> {abilities}"

All templates use HTML tags for formatting (<b>, no markdown). Keep messages clean and readable.
  </action>
  <verify>
Run `npx tsc --noEmit` -- zero errors. Verify MESSAGES object contains RULES_PAGE_ROLLER, RULES_PAGE_SPELGANG, RULES_PAGE_VINST, RULES_PAGE function, STATUS_TEXT, STATUS_DM_EXTRA. Verify all Swedish text uses proper 친칛칬.
  </verify>
  <done>
All rules page templates (3 sections) and status template defined with Guzman voice, HTML formatting, and proper Swedish characters. RULES_PAGE function routes to correct page.
  </done>
</task>

<task type="auto">
  <name>Task 2: /regler with pagination, /status with DM role info, replace placeholder</name>
  <files>
    src/handlers/game-commands.ts
    src/handlers/start.ts
  </files>
  <action>
**game-commands.ts** -- Add /regler and /status to the existing gameCommandsHandler Composer (which already has /avbryt from Plan 02).

NOTE: If Plan 02 hasn't run yet (this plan is Wave 2, parallel with Plan 02), game-commands.ts may not exist yet. In that case, create it as a new file with `export const gameCommandsHandler = new Composer()` and the /regler + /status handlers below. The /avbryt handler will be added by Plan 02. If the file already exists (Plan 02 ran first), append to it.

Import InlineKeyboard from "grammy".
Import MESSAGES from "../lib/messages.js".
Import getActiveGame, getGamePlayersWithInfo from "../db/client.js".
Import getPlayerByTelegramId from "../db/client.js".

**Helper: buildRulesKeyboard(currentPage: string): InlineKeyboard**
Create an InlineKeyboard with 3 buttons in a row:
- "Roller" (callback: "rules:roller") -- if current page, prefix with "[ ]" or use emoji marker
- "Spelg친ng" (callback: "rules:spelgang")
- "Vinst" (callback: "rules:vinst")
Highlight current page by wrapping label with "췉 춺" markers. E.g., current = roller -> "췉 Roller 춺", others -> "Spelg친ng", "Vinst".
Callback data: "rules:roller" = 13 bytes, "rules:spelgang" = 15 bytes, "rules:vinst" = 11 bytes -- all well under 64.

**Helper: getStateDisplayName(state: string): string**
Map game states to Swedish display names:
- "lobby" -> "Lobby (v칛ntar p친 spelare)"
- "active" -> "P친g친r"
- "finished" -> "Avslutat"
- "cancelled" -> "Avbrutet"

**Helper: getRoleDisplayInfo(role: string): { name: string, abilities: string }**
Map roles to display info for DM /status:
- "akta" -> { name: "츿kta", abilities: "Inga specialf칬rm친gor" }
- "golare" -> { name: "Golare", abilities: "Vet vilka andra Golare 칛r" }
- "hogra_hand" -> { name: "Guzmans H칬gra Hand", abilities: "Spaning (kolla en spelares roll)" }

**/regler command handler:**
Works in both group and DM (no chatType filter).
1. Send first page (roller) by default.
2. `ctx.reply(MESSAGES.RULES_PAGE("roller"), { reply_markup: buildRulesKeyboard("roller"), parse_mode: "HTML" })`.

**rules:{page} callback handler** (regex: `/^rules:(.+)$/`):
1. `await ctx.answerCallbackQuery()`.
2. Extract page from ctx.match[1].
3. Validate page is one of "roller", "spelgang", "vinst". If not, return.
4. Get page text: `MESSAGES.RULES_PAGE(page)`.
5. Build keyboard with current page highlighted: `buildRulesKeyboard(page)`.
6. `ctx.editMessageText(text, { reply_markup: keyboard, parse_mode: "HTML" })`. Catch and ignore "message not modified" errors (same helper as lobby.ts -- consider moving isMessageNotModifiedError to a shared utility, OR just duplicate the 5-line helper in this file).

**/status command handler:**
Works in both group and DM (no chatType filter).
1. Determine which game to show status for:
   - In group chat: `getActiveGame(ctx.chat.id)`. If no game, reply "Inget aktivt spel i den h칛r gruppen just nu, bre."
   - In DM: Find the player's active game. `getPlayerByTelegramId(ctx.from.id)` -> get player.id -> query game_players for this player_id where game state is active. For this, add a helper function `getPlayerActiveGame(player_id: string): Promise<Game | null>` to client.ts if it doesn't exist. For Phase 2, assume one active game per player. If no active game found, reply "Du 칛r inte med i n친got aktivt spel just nu, bre."
2. Once we have the game:
   - Get players with info: `getGamePlayersWithInfo(game.id)`.
   - Build player name list: use @username if available, else first_name, else "Ok칛nd".
   - Build status text: `MESSAGES.STATUS_TEXT({ liganScore: game.ligan_score, ainaScore: game.aina_score, round: game.round, totalRounds: 5, state: getStateDisplayName(game.state), players: playerNames, capo: undefined })`. (Capo is undefined in Phase 2 -- set in Phase 3.)
3. If in DM and player has a role assigned:
   - Find the player's game_player record.
   - If role is not null, get display info and append: `statusText += MESSAGES.STATUS_DM_EXTRA(info.name, info.abilities)`.
4. `ctx.reply(statusText, { parse_mode: "HTML" })`.

Note: You may need to add `getPlayerActiveGame` to client.ts. This function should:
- Query game_players where player_id = X
- Join with games where state = 'active'
- Return the Game or null
- Implementation: `supabase.from('game_players').select('*, games(*)').eq('player_id', playerId).eq('games.state', 'active').limit(1).maybeSingle()` -- then extract the game from the joined result.

**start.ts** -- Update the placeholder show_rules callback:

Replace the existing `startHandler.callbackQuery("show_rules", ...)` handler.

The current "Regler" button on welcome messages uses callback_data "show_rules". Two options:
1. Change the callback_data on the rulesKeyboard in start.ts to "rules:roller" (matching the new rules navigation pattern).
2. Keep "show_rules" and redirect to rules page.

Option 1 is cleaner. Update the rulesKeyboard:
```typescript
const rulesKeyboard = new InlineKeyboard().text("Regler 游닀", "rules:roller");
```

Remove the old `startHandler.callbackQuery("show_rules", ...)` handler entirely. The "rules:roller" callback will be handled by gameCommandsHandler's regex pattern.

Verify gameCommandsHandler is registered in bot.ts BEFORE any handler that might need the rules:* callback. Since bot.ts registers handlers in order (startHandler, lobbyHandler, gameCommandsHandler), and grammY propagates to all middleware, the rules callback in gameCommandsHandler will catch "rules:roller" from the welcome message button. This works because grammY middleware runs in registration order and the callback query will match the regex in gameCommandsHandler.

Actually -- there's a subtlety. The "rules:roller" callback from the welcome message button will pass through startHandler first (which no longer has a "show_rules" handler), then lobbyHandler (which handles join/leave/start), then gameCommandsHandler (which handles "rules:*"). The regex `/^rules:(.+)$/` will match and handle it correctly. This is fine.
  </action>
  <verify>
Run `npx tsc --noEmit` -- zero errors. Verify /regler sends paginated rules with inline buttons. Verify rules:* callback navigates between pages. Verify /status shows game state in group. Verify /status in DM shows role info. Verify start.ts no longer has the placeholder "show_rules" handler. Verify the Regler button now uses "rules:roller" callback data. Verify all Swedish text uses proper 친칛칬.
  </verify>
  <done>
/regler shows paginated rules with 3 sections (Roller, Spelg친ng, Vinst) navigable via inline buttons. /status shows score, round, phase, and player list in group; in DM also shows player's own role and abilities. Phase 1 placeholder rules callback replaced with real rules navigation. Both commands work in group chat and DM.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. /regler sends first page (Roller) with 3 navigation buttons
3. Clicking "Spelg친ng" or "Vinst" buttons updates the message content and highlights the active tab
4. /status in group shows score, round, player list
5. /status in DM shows same + player's own role
6. Both commands work in group AND DM
7. Regler button on welcome messages now opens real rules (not placeholder)
8. All Swedish text uses proper 친칛칬 characters
</verification>

<success_criteria>
- /regler accessible by any player, paginated with Roller/Spelg친ng/Vinst sections
- /regler inline buttons navigate between pages without sending new messages
- /status shows Ligan score, Aina score, current round, game state, and player list
- /status in DM additionally shows the player's secret role and abilities
- Both commands work in group chat and private DM
- Phase 1 Regler button placeholder replaced with real rules page
</success_criteria>

<output>
After completion, create `.planning/phases/02-game-lobby/02-03-SUMMARY.md`
</output>
