---
phase: 03-game-loop
plan: 04
type: execute
wave: 3
depends_on: ["03-02", "03-03"]
files_modified:
  - src/handlers/game-loop.ts
  - src/lib/messages.ts
autonomous: true

must_haves:
  truths:
    - "When Ligan wins (3 successful missions), Golare get to guess who is Hogra Hand"
    - "When Aina wins (3 failed missions), Akta get to guess one Golare"
    - "Guessing team receives DMs with inline buttons listing candidate player names"
    - "First valid guess locks in the choice (first-guess-wins)"
    - "Guessing team has a 2-hour window to discuss and vote"
    - "Final reveal is delayed and dramatic with 30-60 second pacing between messages"
    - "All player roles are revealed at game end"
    - "Game transitions to finished state after final reveal"
  artifacts:
    - path: "src/handlers/game-loop.ts"
      provides: "Sista Chansen flow, final reveal sequence, game end logic"
      contains: "sista_chansen"
  key_links:
    - from: "src/handlers/game-loop.ts"
      to: "src/db/client.ts"
      via: "creates/reads sista_chansen records"
      pattern: "createSistaChansen|getSistaChansen"
    - from: "src/handlers/game-loop.ts"
      to: "src/lib/messages.ts"
      via: "uses Sista Chansen and final reveal templates"
      pattern: "MESSAGES\\.SISTA_CHANSEN|MESSAGES\\.FINAL_REVEAL"
---

<objective>
Implement the Symmetrisk Sista Chansen endgame mechanic and the full end-of-game flow -- the dramatic conclusion where the losing side gets one chance to steal the win, followed by a full role reveal.

Purpose: Sista Chansen is the climactic moment of the entire game. Without it, a game ending at 3-0 feels anticlimactic. The symmetric mechanic ensures both sides always have a dramatic finish and comeback potential.

Output: Sista Chansen logic in game-loop.ts (DMs to guessers, guess callback, result + reveal sequence), game end with full role reveal.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-game-loop/03-CONTEXT.md
@.planning/phases/03-game-loop/03-RESEARCH.md
@.planning/phases/03-game-loop/03-01-SUMMARY.md
@.planning/phases/03-game-loop/03-02-SUMMARY.md
@.planning/phases/03-game-loop/03-03-SUMMARY.md
@src/db/types.ts
@src/db/client.ts
@src/lib/game-state.ts
@src/lib/messages.ts
@src/handlers/game-loop.ts
@src/queue/message-queue.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Sista Chansen guessing flow</name>
  <files>
    src/handlers/game-loop.ts
  </files>
  <action>
Modify game-loop.ts to replace the temporary "set game to finished" logic from Plan 03 with the full Sista Chansen flow:

**Triggering Sista Chansen** (modify the win condition check in handleResultReveal and early resolution):

When `checkWinCondition(liganScore, ainaScore)` returns a winner:

1. Determine the guessing side via `getSistaChansenSide(liganScore, ainaScore)`:
   - Ligan wins (liganScore >= 3): guessing_side = "golare" (Golare guess Hogra Hand)
   - Aina wins (ainaScore >= 3): guessing_side = "akta" (Akta guess one Golare)

2. Do NOT set game state to 'finished' yet. Instead, keep game state as 'active' but mark that Sista Chansen is in progress (we can use a convention: check if sista_chansen record exists for this game).

3. Send SISTA_CHANSEN_INTRO to group chat explaining what's happening: "Spelet ar inte over an! {guessing side} far en sista chans att stjala vinsten..."

4. Determine the guessing team members:
   - If guessing_side is "golare": get all game_players with role='golare'
   - If guessing_side is "akta": get all game_players with role='akta' (NOT hogra_hand -- they are Akta but shouldn't vote to identify themselves)

5. Determine the candidate targets:
   - If guessing Hogra Hand: candidates are ALL players (guessers don't know who is Hogra Hand, could be anyone not on the Golare team)
   - If guessing a Golare: candidates are ALL players minus the Akta team members (but the guessers don't know for sure, so candidates should be ALL players excluding the guessers themselves)
   - Actually, for maximum fairness and simplicity: show ALL players as candidates (minus the guessers themselves). This prevents information leakage.

6. Build inline keyboard with candidate names: `sc:{gameId}:{playerIndex}` for each candidate.

7. Send SISTA_CHANSEN_DM to each guesser via DM with the candidate keyboard. Include explanation: "Ni har 2 timmar. Forsta gissningen galler!" (per locked decision: first-guess-wins for simplicity).

8. Set a timeout for the 2-hour window. Use `setTimeout` (not Croner -- this is a one-shot timer, not a recurring schedule). Store the timeout reference so it can be cleared if a guess comes in early.
   - When timeout fires: check if a guess has been made (query sista_chansen table).
   - If no guess: the original winner wins. Send SISTA_CHANSEN_TIMEOUT and proceed to final reveal.

**Guess callback** -- `callbackQuery(/^sc:(.+):(\d+)$/)`:

1. Extract gameId and playerIndex.
2. Get game. Check that game is still 'active' and a sista_chansen has NOT already been recorded (first-guess-wins).
3. Get the guesser's game_player info. Verify they are on the guessing team (check role matches guessing_side).
4. Resolve the target player from the playerIndex (using ordered player list).
5. Determine if the guess is correct:
   - If guessing Hogra Hand: check if target player's role is 'hogra_hand'. Correct = Golare steal the win.
   - If guessing a Golare: check if target player's role is 'golare'. Correct = Akta steal the win.
6. Record the guess: `createSistaChansen(gameId, guessingSide, targetPlayerId, guesserId)` with correct=true/false.
7. Send SISTA_CHANSEN_GUESS_MADE to group: "{guesser} pekar pa {target}..."
8. Edit the guesser's DM to remove buttons.
9. Also edit ALL other guessers' DMs to remove buttons (the guess is locked -- no more voting).
10. Clear the 2-hour timeout.
11. Proceed to the dramatic reveal sequence (see Task 2).

**Important notes:**
- First-guess-wins: The callback checks if a sista_chansen record already exists. If it does, answer with "Gissningen ar redan gjord, bre." and return.
- The 2-hour timeout must survive bot restarts. For simplicity in v1: use in-memory setTimeout. If bot restarts during Sista Chansen, on startup recovery (recoverMissedEvents), check for active games with a sista_chansen pending (no record in sista_chansen table but win condition met). If found and more than 2 hours have passed, auto-resolve as timeout.
- Per locked decision: "Guess presented as inline buttons with all player names (same UX pattern as other votes)."
  </action>
  <verify>
    Run `npx tsc --noEmit`. Grep game-loop.ts for: sc: callback handler, createSistaChansen, getSistaChansenSide, SISTA_CHANSEN.
  </verify>
  <done>
    Sista Chansen triggers when a side reaches 3 wins. Golare guess Hogra Hand or Akta guess one Golare via DM inline buttons. First guess locks in the choice. 2-hour timeout auto-resolves if no guess.
  </done>
</task>

<task type="auto">
  <name>Task 2: Dramatic reveal sequence and game end</name>
  <files>
    src/handlers/game-loop.ts
    src/lib/messages.ts
  </files>
  <action>
**Dramatic reveal sequence** (called after Sista Chansen resolves or times out):

Create an async function `performFinalReveal(bot: Bot, game: Game, sistaChansen: SistaChansen | null)`:

1. **Build suspense** (per locked decision: "Final reveal is delayed and dramatic -- Guzman builds suspense with a message sequence before showing the result (30-60 second pacing)"):

   Send a sequence of suspense messages to the group with delays:
   - Message 1: "..." (30 second pause)
   - Message 2: Guzman builds tension -- "Jag har kollat pappren..." (30 second pause)
   - Message 3: Reveal the Sista Chansen result:
     - If Sista Chansen was played:
       - If correct: SISTA_CHANSEN_CORRECT -- the stealing side wins! Dramatic reversal.
       - If wrong: SISTA_CHANSEN_WRONG -- original winner confirmed.
     - If Sista Chansen timed out:
       - SISTA_CHANSEN_TIMEOUT -- original winner confirmed.
     - If no Sista Chansen was needed (shouldn't happen in normal flow, but safety check):
       - Just announce the winner.
   - 30 second pause

2. **Determine final winner:**
   - If Sista Chansen correct guess: the stealing side wins (reverse the initial winner).
   - Otherwise: the initial winner wins.
   - Send the final winner announcement.

3. **Full role reveal** (30 second pause, then):
   - Get all game_players with player info.
   - Build FINAL_REVEAL message listing every player and their true role:
     ```
     AVSLOJNINGEN:
     - @player1: Akta
     - @player2: GOLARE
     - @player3: Guzmans Hogra Hand
     - ...
     ```
   - Mark Golare roles prominently (bold, rat emoji). Mark Hogra Hand with special indicator.
   - Send to group.

4. **Set game state to 'finished':**
   - `updateGame(game.id, { state: 'finished' })`.
   - Log game completion.

**Implementation of delays:**
Use `await sleep(30000)` (the sleep helper from message-queue.ts -- or create a new one). The delays are 30-60 seconds of real time. This is fine because:
- This function runs in response to a callback query or timeout, not blocking any cron job.
- MessageQueue handles the actual sending rate limits.
- Each message is sent sequentially with delays.

**Edge case -- bot restart during reveal sequence:**
- If bot restarts mid-reveal, the game state is still 'active'. The recoverMissedEvents function should detect this (sista_chansen record exists with correct/incorrect flag, but game.state still 'active') and re-run the final reveal immediately (without the dramatic pauses -- just send the results).

**Update messages.ts if any reveal-sequence messages are missing:**
- Add SUSPENSE_1, SUSPENSE_2 as short Guzman tension-building messages (these can be simple strings, not functions).
- Verify FINAL_REVEAL template properly formats the full role list with names and roles.
- Verify all SISTA_CHANSEN templates handle both scenarios (correct/wrong/timeout) with proper Swedish aao.

**Wire into existing code:**
- In the handleResultReveal function (and early resolution), replace the temporary "set game to finished" logic with:
  1. If win condition met: start Sista Chansen flow (Task 1).
- In the Sista Chansen guess callback: after recording the guess, call `performFinalReveal(bot, game, sistaChansen)`.
- In the 2-hour timeout handler: after timeout, call `performFinalReveal(bot, game, null)` (no guess made -- original winner wins).
  </action>
  <verify>
    Run `npx tsc --noEmit`. Grep game-loop.ts for: performFinalReveal, FINAL_REVEAL, SUSPENSE, sleep, state: 'finished'. Verify messages.ts has SUSPENSE_1, SUSPENSE_2, and all SISTA_CHANSEN variants.
  </verify>
  <done>
    Sista Chansen resolution triggers a dramatic multi-message reveal with 30-60 second pacing. Correct guess reverses the winner. All player roles revealed at game end. Game state set to 'finished'. The complete 5-round game with Sista Chansen endgame is fully functional end-to-end.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. Sista Chansen triggers when a side reaches 3: Golare guess Hogra Hand, or Akta guess one Golare
3. DMs sent to guessing team with inline keyboard of candidate names
4. First guess locks in (unique check in callback)
5. 2-hour timeout auto-resolves if no guess
6. Dramatic reveal: 3-4 messages with 30-second delays
7. Full role reveal lists every player and their true role
8. Game transitions to 'finished' after reveal
9. All messages use proper Swedish aao characters
</verification>

<success_criteria>
The complete Phase 3 game loop is fully functional: a 5-round game plays through the daily cycle (mission -> nomination -> voting -> execution -> reveal), with Kaos-mataren handling failed votes, and Sista Chansen providing a dramatic endgame. The game concludes with a delayed dramatic reveal sequence and full role transparency. Template messages handle all scenarios in Guzman's Swedish suburb slang persona.
</success_criteria>

<output>
After completion, create `.planning/phases/03-game-loop/03-04-SUMMARY.md`
</output>
