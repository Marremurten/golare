---
phase: 03-game-loop
plan: 03
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/handlers/game-loop.ts
  - src/handlers/game-commands.ts
autonomous: true

must_haves:
  truths:
    - "At 18:00, each approved team member receives a DM with [Sakra] and [Gola] buttons"
    - "Team members who don't choose before deadline default to Sakra (assumes loyalty)"
    - "At 21:00, Guzman reveals mission result in group: success/fail + sabotage count (not who)"
    - "After reveal, game score is updated (ligan_score or aina_score incremented)"
    - "First side to reach 3 wins triggers end-of-game (or Sista Chansen)"
    - "Team size scales with player count (2 for 4-5, 3 for 6-8, 4 for 9-10)"
    - "/status command shows current round phase and score during active game"
  artifacts:
    - path: "src/handlers/game-loop.ts"
      provides: "Execution callbacks (ms:/mg:), execution deadline handler, result reveal handler, win condition check"
      contains: "handleExecutionDeadline"
    - path: "src/handlers/game-commands.ts"
      provides: "Updated /status with round phase display"
      contains: "getStateDisplayName"
  key_links:
    - from: "src/handlers/game-loop.ts"
      to: "src/db/client.ts"
      via: "reads/writes mission_actions, updates game scores"
      pattern: "castMissionAction|getMissionActionsForRound|updateGame"
    - from: "src/handlers/game-loop.ts"
      to: "src/lib/game-state.ts"
      via: "uses computeMissionResult and checkWinCondition"
      pattern: "computeMissionResult|checkWinCondition"
    - from: "src/handlers/game-loop.ts"
      to: "src/lib/messages.ts"
      via: "uses execution and reveal templates"
      pattern: "MESSAGES\\.EXECUTION_|MESSAGES\\.MISSION_|MESSAGES\\.SCORE_|MESSAGES\\.GAME_WON"
---

<objective>
Implement the mission execution (18:00) and result reveal (21:00) phases, plus win condition tracking -- completing the daily game cycle. Team members secretly choose Sakra/Gola via DM buttons, results are revealed with sabotage count, scores update, and win conditions trigger Sista Chansen or end the game.

Purpose: This completes the daily round lifecycle. Without execution and reveal, the voting phase has no consequence -- the core tension of "will someone betray?" doesn't exist.

Output: Execution callbacks and scheduler handlers in game-loop.ts, updated /status display in game-commands.ts.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-game-loop/03-CONTEXT.md
@.planning/phases/03-game-loop/03-RESEARCH.md
@.planning/phases/03-game-loop/03-01-SUMMARY.md
@src/db/types.ts
@src/db/client.ts
@src/lib/game-state.ts
@src/lib/messages.ts
@src/handlers/game-loop.ts
@src/handlers/game-commands.ts
@src/queue/message-queue.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Execution phase -- DM buttons, deadline handling, and result reveal</name>
  <files>
    src/handlers/game-loop.ts
  </files>
  <action>
Add the following to the existing game-loop.ts handler (this plan extends what Plan 02 created):

**Scheduler handler functions** (add to createScheduleHandlers):

1. `handleExecutionReminder()` -- Called at 17:00:
   - For each active game, get current round.
   - If phase is 'execution':
     - Get team members (from team_player_ids on round). Get their player info for DM chat IDs.
     - Get existing mission actions for this round.
     - For each team member who HASN'T submitted an action yet:
       - Send EXECUTION_REMINDER DM to the player.
     - If any pending, also send EXECUTION_REMINDER_GROUP to the group chat (generic "Some team members haven't chosen yet" -- per locked decision, reminders in both DM and group).

2. `handleExecutionDeadline()` -- Called at 18:00:
   - For each active game, get current round.
   - If phase is 'voting' and team was just approved (rare timing edge case -- voting resolved but execution DMs not yet sent because vote resolved exactly at 18:00):
     - Send execution DMs (same as what happens when vote is approved -- see below).
   - If phase is 'execution':
     - Get all mission actions for this round.
     - Get team members. For each team member without an action:
       - Default to Sakra (per locked decision: "Team member doesn't choose = defaults to Sakra").
       - Insert a mission_action with action='sakra' for this player.
       - Send EXECUTION_DEFAULT DM to the player ("Du valde inte i tid, bre. Jag antar att du ar lojal -- Sakra.").
     - Phase stays in 'execution' -- the 21:00 handler will resolve the mission.
   - If phase is 'nomination' (still waiting for nomination that was delayed):
     - This means the Capo STILL hasn't nominated after being rotated at 15:00. Auto-fail this as another failed vote.
     - Increment consecutive_failed_votes. Check Kaos-mataren (>= 3 total).
     - If kaos: auto-fail, set mission_result='kaos_fail', transition to 'reveal'.
     - If not kaos: rotate Capo again, re-send nomination prompt.

3. `handleResultReveal()` -- Called at 21:00:
   - For each active game, get current round.
   - If phase is 'execution':
     - Transition to 'reveal'.
     - Get all mission actions. Call `computeMissionResult(actions, game.team_size)`.
     - Set mission_result on round: 'success' if golaCount === 0, else 'fail'.
     - Set ligan_point: true if success (Ligan scored), false if fail (Aina scored).
     - Update game scores: if success, increment ligan_score; if fail, increment aina_score.
     - Send result message to group:
       - If success: MISSION_SUCCESS
       - If fail: MISSION_FAIL(golaCount) -- "Uppdraget misslyckades. {N} golare saboterade." (per locked decision)
     - Send SCORE_UPDATE with current scores.
     - Check win condition: `checkWinCondition(liganScore, ainaScore)`.
       - If a side has 3: determine Sista Chansen side via `getSistaChansenSide()`. Set game state appropriately (DON'T set to 'finished' yet -- Sista Chansen comes first). Send GAME_WON_LIGAN or GAME_WON_AINA to group. The Sista Chansen flow will be handled by Plan 04.
         - For now: if win condition is met, update the game state to 'finished' temporarily. Plan 04 will change this to trigger Sista Chansen instead.
         - Also send ROUND_END (but with "SPELET AR OVER" variant).
       - If no winner yet: Send ROUND_END("Runda {N} klar. Nasta runda imorgon 09:00."). Phase stays in 'reveal'. Tomorrow's 09:00 handler will create the next round.
   - If phase is 'reveal' and mission_result is 'kaos_fail' (auto-failed from Kaos-mataren):
     - The Kaos fail was already applied by the voting deadline handler. Just send the reveal messages (already scored).
     - Send KAOS_TRIGGERED + MISSION_FAIL + SCORE_UPDATE.
     - Check win condition as above.

**When vote is approved** (hook into Plan 02's vote resolution logic):

After vote is approved and phase transitions to 'execution':
- Get team members from team_player_ids. Look up their player info for DM chat IDs.
- For each team member, send EXECUTION_PROMPT DM with inline keyboard:
  - "Sakra uppdraget" button with callback `ms:{gameId}:{roundNumber}`
  - "Gola!" button with callback `mg:{gameId}:{roundNumber}`
- Send via MessageQueue to each player's DM. Use Promise.all with catch-and-log per DM (same pattern as role DM delivery in lobby.ts).

**Callback handlers** (add to the Composer):

4. **Mission Sakra** -- `callbackQuery(/^ms:(.+):(\d+)$/)`:
   - Extract gameId and roundNumber.
   - Get game, current round. Verify 'execution' phase and round_number matches.
   - Get player by telegram_user_id within this game.
   - Verify this player is on the team (their game_player id is in round.team_player_ids).
   - Call `castMissionAction(round.id, gamePlayer.id, 'sakra')`. Handle double-click (unique constraint) gracefully.
   - Edit the DM message to remove buttons: "Du valde Sakra. Lojal, bre."
   - Check if all team members have now submitted: if so, resolve early (don't wait for 21:00):
     - Get all actions, compute result, update scores, send reveal to group.
     - Transition to 'reveal'.
   - Answer callback query.

5. **Mission Gola** -- `callbackQuery(/^mg:(.+):(\d+)$/)`:
   - Same as Sakra but with action='gola'.
   - Edit DM to: "Du valde Gola. Forradare... üêÄ"
   - Same early resolution check.

**Important notes:**
- When all team members have acted before the 21:00 deadline, resolve immediately rather than waiting. The 21:00 handler should check if already resolved (phase is already 'reveal') and skip.
- Mission results: "Uppdraget misslyckades. 2 golare saboterade." -- reveals count but NOT who (per locked decision).
- Default Sakra for missing actions at 18:00 deadline (per locked decision).
- All DMs via MessageQueue with separate per-chat queues (DM chat IDs are per-player).
  </action>
  <verify>
    Run `npx tsc --noEmit` and confirm zero type errors. Grep game-loop.ts for: ms: and mg: callback handlers, handleExecutionReminder, handleExecutionDeadline, handleResultReveal, computeMissionResult, checkWinCondition, EXECUTION_PROMPT, MISSION_SUCCESS, MISSION_FAIL, SCORE_UPDATE.
  </verify>
  <done>
    Execution phase sends DM buttons to team members. Sakra/Gola callbacks record actions and resolve early when all team members act. Deadline at 18:00 defaults missing actions to Sakra. Result reveal at 21:00 shows success/fail + sabotage count. Game scores update after each round. Win condition (first to 3) checked after every reveal.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update /status with round phase display</name>
  <files>
    src/handlers/game-commands.ts
  </files>
  <action>
Update the `/status` command in game-commands.ts to show richer information during active games:

1. In the group chat status handler, after getting the game:
   - Import `getCurrentRound` from db/client.ts.
   - If game.state is 'active', get the current round via `getCurrentRound(game.id)`.
   - If a round exists, include round phase in the status display.

2. Update `getStateDisplayName()` to handle round phases:
   - Add cases for round phases when game is active:
     - "mission_posted" -> "Uppdrag postat"
     - "nomination" -> "Capo-val pagaende"
     - "voting" -> "Rostning pagaende"
     - "execution" -> "Stoten pagaende"
     - "reveal" -> "Resultat avslojas"
   - The function receives game state, but now also needs round phase. Adjust to accept optional roundPhase parameter.

3. In the STATUS_TEXT call, pass the round phase display name instead of just the game state when a round is active.

4. Also show the current Capo name in the player list (mark with crown emoji, matching existing pattern) when a round with a Capo is active. Get the Capo by looking up capo_player_id from the round, joining to players for the display name.

5. Similarly update the DM /status handler to include round phase info.
  </action>
  <verify>
    Run `npx tsc --noEmit` and confirm zero type errors. Verify getStateDisplayName handles round phases.
  </verify>
  <done>
    /status shows current round number, phase (in Swedish), score, Capo name during active games. Both group and DM contexts display round phase info.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. game-loop.ts has ms: and mg: callback handlers for Sakra/Gola
3. game-loop.ts has handleExecutionReminder, handleExecutionDeadline, handleResultReveal
4. Mission result computation uses computeMissionResult from game-state.ts
5. Win condition checked after every reveal via checkWinCondition
6. Default Sakra on missing actions at deadline
7. Early resolution when all team members act before deadline
8. /status shows round phase and Capo during active games
</verification>

<success_criteria>
The full daily round cycle is complete: team members receive Sakra/Gola DM buttons, actions default to Sakra at deadline, results reveal success/fail with sabotage count, scores update, and win conditions are checked. The /status command provides real-time game state including round phase and Capo identity. A complete 5-round game can now play through from start to win (minus Sista Chansen).
</success_criteria>

<output>
After completion, create `.planning/phases/03-game-loop/03-03-SUMMARY.md`
</output>
