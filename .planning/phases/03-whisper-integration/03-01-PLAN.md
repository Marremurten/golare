---
phase: 03-whisper-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/behavioral-analysis.ts
  - src/lib/ai-prompts.ts
autonomous: true

must_haves:
  truths:
    - "Whisper prompts include 1-2 actual message quotes (paraphrased, never verbatim) for the target player"
    - "Whisper prompts include an all-players behavioral overview for context"
    - "Prompt rules enforce oblique references only -- Guzman speaks from gut feeling, never quotes directly or references timestamps"
    - "Prompt escalates intensity over game rounds (vague early, pointed late)"
    - "Prompt includes role-aware paranoia calibration (aggressive for golare, seductive for akta)"
  artifacts:
    - path: "src/lib/behavioral-analysis.ts"
      provides: "selectQuotesForWhisper() and buildAllPlayerOverview() helpers"
      exports: ["selectQuotesForWhisper", "buildAllPlayerOverview"]
    - path: "src/lib/ai-prompts.ts"
      provides: "Rewritten buildWhisperPrompt with behavioral data, escalation, role calibration"
      exports: ["buildWhisperPrompt"]
  key_links:
    - from: "src/lib/behavioral-analysis.ts"
      to: "PlayerMessage type"
      via: "import from db/types"
      pattern: "import.*PlayerMessage.*from"
    - from: "src/lib/ai-prompts.ts"
      to: "PlayerRole type"
      via: "import from db/types"
      pattern: "import.*PlayerRole.*from"
---

<objective>
Create behavioral data preparation helpers and rewrite the whisper prompt to make Guzman behavior-aware.

Purpose: This provides the data extraction functions (selecting message quotes for whisper context, building all-player behavioral overview) and the completely rewritten whisper prompt that transforms Guzman from generic suspicion-sower into a gossip dealer who references actual player behavior with role-aware paranoia calibration and round-based escalation.

Output: Two modified files -- behavioral-analysis.ts with new exported helpers, ai-prompts.ts with rewritten buildWhisperPrompt signature and body.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-whisper-integration/03-CONTEXT.md
@.planning/phases/03-whisper-integration/03-RESEARCH.md
@src/lib/behavioral-analysis.ts
@src/lib/ai-prompts.ts
@src/db/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add selectQuotesForWhisper and buildAllPlayerOverview to behavioral-analysis.ts</name>
  <files>src/lib/behavioral-analysis.ts</files>
  <action>
Add two new exported functions to behavioral-analysis.ts:

1. `selectQuotesForWhisper(messages: PlayerMessage[], count: number = 2): string[]`
   - Takes a player's recent messages (from getRecentPlayerMessages) and selects the best 1-2 for whisper context
   - Selection heuristic: prefer messages with most behavioral signal -- score by (a) message length (longer = more content), (b) keyword richness (count of TONE_KEYWORDS matches), (c) presence of other player name mentions
   - Sort by score descending, take top `count`
   - Return the raw message_text strings (the AI will paraphrase, not us)
   - If messages array is empty, return empty array
   - If only 1 message exists, return just that one regardless of count

2. `buildAllPlayerOverview(playerNotes: Record<string, string>, targetName: string): string`
   - Takes all playerNotes (from GuzmanContext) and the target player's name
   - Builds a compressed overview string for the whisper prompt showing what all OTHER players are doing
   - Format: one line per player, e.g. "Ahmed: anklagande, hog aktivitet | Sara: tyst, inaktiv | ..."
   - Skip the target player (they get their own section in the prompt)
   - If a player note is just "inaktiv", include them but keep it brief
   - If playerNotes is empty or only contains target, return "Ingen info om andra spelare"
   - Hard-cap at 500 characters total (truncate with "..." if needed) to respect CONST-02 token budget

Both functions are pure (no DB calls, no side effects). Export them alongside existing exports.
  </action>
  <verify>
Run `npx tsc --noEmit` to confirm no type errors. Verify both functions are exported by checking the file contains `export function selectQuotesForWhisper` and `export function buildAllPlayerOverview`.
  </verify>
  <done>
Two new pure functions exported from behavioral-analysis.ts: selectQuotesForWhisper selects highest-signal messages for whisper context, buildAllPlayerOverview builds a compressed multi-player summary string excluding the target.
  </done>
</task>

<task type="auto">
  <name>Task 2: Rewrite buildWhisperPrompt with behavioral data, gossip-dealer persona, escalation, and role calibration</name>
  <files>src/lib/ai-prompts.ts</files>
  <action>
Rewrite the `buildWhisperPrompt` function signature and body in ai-prompts.ts.

NEW SIGNATURE:
```typescript
export function buildWhisperPrompt(
  gameContext: GuzmanContext,
  targetPlayerName: string,
  targetRole: PlayerRole,
  otherPlayerNames: string[],
  roundEvents: string,
  targetQuotes: string[],
  allPlayerOverview: string,
  roundNumber: number,
): string
```

The prompt body must implement these requirements from CONTEXT.md and RESEARCH.md:

**Gossip-dealer persona (WHISP-03):**
- Guzman is a skvallerkung (gossip king) who "heard things" -- never quotes directly, never references timestamps
- Frame everything as rumors: "Mannen, du vet inte vad folk sager om dig...", "Jag har hort grejer..."
- Use "magkansla" (gut feeling) framing, never "jag sag att du skrev..."

**Target quotes section (WHISP-01):**
- Include targetQuotes in a section labeled SPELARENS SENASTE AKTIVITET (only visible to AI, never repeated verbatim)
- Instruct AI: "Parafrasera och vrida -- aldrig citera rakt av. Guzman har 'hort' saker, inte 'last' dem."
- If targetQuotes is empty: instruct AI to speculate and create atmosphere ("Du har vart for tyst, mannen...")

**All-player overview section (WHISP-02):**
- Include allPlayerOverview in a section labeled OVRIGA SPELARE
- Instruct AI: "Anvand detta for att skapa paranoia -- jamfor spelaren med andra, droppa antydningar"

**Role-aware paranoia calibration:**
- Add a GUZMAN APPROACH section that varies by targetRole:
  - "golare": aggressive, confrontational, suspicious -- "Guzman pressar hart. Hota, ifraga, skapa stress."
  - "akta": seductive, conspiratorial -- "Guzman ar forforisk. Drag in spelaren i hemligheter, skapa exklusivitet."
  - "hogra_hand": respectful but testing loyalty -- "Guzman ar respektfull men testar lojalitet. Droppa exklusiv info."

**Round-based escalation:**
- Add an INTENSITET section:
  - Round 1-2: "Vag, atmosfarisk. Bygg stanning, droppa vaga antydningar."
  - Round 3: "Mer specifik. Namna beteenden, var mer direkt med parafraseringar."
  - Round 4-5: "Maximal intensitet. Pekat, dramatiskt, hog press. Guzman vet allt."

**Trust/doubt/lies strategy:**
- Keep the existing truth strategy selection (SANNING, HALV_SANNING, LOGN) but add a 4th option: FORSAKRAN (reassurance as manipulation) -- "du ar den enda jag litar pa"
- RARELY include a complete lie as wildcard (instruct AI: "Hogst 1 av 5 viskningar bor vara ren logn")

**Critical rules section (WHISP-03, CONST-03):**
- ALDRIG citera ordagrant fran spelarmeddelanden
- ALDRIG referera till tidpunkter ("kl 14:32 sa du...")
- ALDRIG avsloja spelares roller
- Allt beteendedata ar internt -- framstall det som Guzmans "magkansla" och rykten
- Anvand BARA namnen som listas. Hitta ALDRIG PA namn.

**Output format:**
- Keep the existing structured output requirement: first line [SANNING], [HALV_SANNING], [LOGN], or [FORSAKRAN]
- Max 500 tecken for the message body
- HTML formatting: <b> and <i> only

IMPORTANT: All Swedish text must use proper characters. Double-check every string for correct usage of a, a, o / A, A, O.
  </action>
  <verify>
Run `npx tsc --noEmit` to confirm no type errors (the new signature won't match callers yet -- that's expected and fixed in Plan 02). Manually inspect the prompt text to confirm: (1) no verbatim quote instructions exist, (2) gossip-dealer framing is present, (3) role calibration section exists with 3 role variants, (4) escalation section has 3 tiers, (5) all Swedish text uses proper characters.
  </verify>
  <done>
buildWhisperPrompt accepts 8 parameters (up from 4), produces a behavior-aware gossip-dealer prompt with role calibration, round escalation, quote paraphrasing rules, all-player overview, and strict WHISP-03 oblique-reference rules. TypeScript compiles. Swedish text uses proper characters throughout.
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes (note: callers of buildWhisperPrompt/generateWhisperMessage will have type errors until Plan 02 updates them -- this is expected)
- behavioral-analysis.ts exports selectQuotesForWhisper and buildAllPlayerOverview
- ai-prompts.ts buildWhisperPrompt has 8-param signature
- Prompt text contains no "citera ordagrant" or "exact quote" patterns
- Prompt text contains role calibration for all 3 roles (golare, akta, hogra_hand)
- Prompt text contains escalation tiers for rounds 1-2, 3, 4-5
- All Swedish text uses proper characters
</verification>

<success_criteria>
- Two new pure helper functions in behavioral-analysis.ts for whisper data preparation
- Completely rewritten buildWhisperPrompt with gossip-dealer persona, behavioral data sections, role calibration, round escalation, and strict oblique-reference rules
- TypeScript compiles (minus expected caller mismatches resolved in Plan 02)
- Requirements WHISP-01, WHISP-02, WHISP-03 are addressed at the prompt level
</success_criteria>

<output>
After completion, create `.planning/phases/03-whisper-integration/03-01-SUMMARY.md`
</output>
