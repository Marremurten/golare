---
phase: 04-gap-fill-accusations
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/behavioral-analysis.ts
  - src/lib/ai-prompts.ts
  - src/lib/ai-guzman.ts
autonomous: true

must_haves:
  truths:
    - "Group mood is computed from behavioral data at gap-fill time (not stored)"
    - "Gap-fill prompts are always provocative but adapt content/tone to group mood"
    - "Accusation prompts reference specific observed behavior, never fabricate"
    - "generateAccusation returns null on AI failure (CONST-04)"
    - "Accusation prompt never receives player roles"
  artifacts:
    - path: "src/lib/behavioral-analysis.ts"
      provides: "computeGroupMood() and selectAccusationTarget()"
      exports: ["computeGroupMood", "selectAccusationTarget"]
    - path: "src/lib/ai-prompts.ts"
      provides: "buildAccusationPrompt() and mood-aware buildGapFillPrompt()"
      exports: ["buildAccusationPrompt", "buildGapFillPrompt"]
    - path: "src/lib/ai-guzman.ts"
      provides: "generateAccusation() and mood-aware generateGapFillComment()"
      exports: ["generateAccusation", "generateGapFillComment"]
  key_links:
    - from: "src/lib/behavioral-analysis.ts"
      to: "src/handlers/whisper-handler.ts"
      via: "computeGroupMood and selectAccusationTarget called from whisper-handler runGapFill"
      pattern: "computeGroupMood|selectAccusationTarget"
    - from: "src/lib/ai-prompts.ts"
      to: "src/lib/ai-guzman.ts"
      via: "buildAccusationPrompt called by generateAccusation"
      pattern: "buildAccusationPrompt"
    - from: "src/lib/ai-guzman.ts"
      to: "src/lib/ai-client.ts"
      via: "MODEL_MAP.commentary for accusation generation"
      pattern: "MODEL_MAP\\.commentary"
---

<objective>
Build the mood computation, accusation target selection, prompt builders, and AI generation functions for mood-adaptive gap-fill and public accusations.

Purpose: These are the building blocks that Plan 02 will wire into the gap-fill schedule. Separating generation from delivery keeps each plan focused and under context budget.
Output: Three extended modules with group mood computation, accusation target selection, mood-aware gap-fill prompt, accusation prompt, and `generateAccusation()`.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/lib/behavioral-analysis.ts
@src/lib/ai-prompts.ts
@src/lib/ai-guzman.ts
@src/lib/ai-client.ts
@src/db/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Group mood computation and accusation target selection</name>
  <files>src/lib/behavioral-analysis.ts</files>
  <action>
Add two new exported functions to `behavioral-analysis.ts`:

**1. `computeGroupMood(playerNotes: Record<string, string>): GroupMood`**

Add a type alias `GroupMood = "tense" | "active" | "calm"` (exported).

Compute mood from the playerNotes values (these are the summary strings like "Ton: anklagande | Aktivitet: hog | Anomali: aggressionsökning"):
- Count how many players have tone "anklagande" or anomalies containing "aggression" or "beteendeförändring" -> `tenseSignals`
- Count how many players have "Aktivitet: hög" or "Aktivitet: medel" -> `activeSignals`
- Total player count from Object.keys(playerNotes).length

Decision logic:
- If fewer than 2 playerNotes entries -> return "active" (default when insufficient data, per research)
- If `tenseSignals >= totalPlayers * 0.4` -> return "tense"
- If `activeSignals >= totalPlayers * 0.5` -> return "active"
- Else -> return "calm"

**2. `selectAccusationTarget(playerNotes: Record<string, string>, lastTargetedName: string | null): { name: string; anomalies: string; evidence: string } | null`**

Scan playerNotes for players with anomaly signals. For each player:
- Skip if player name === lastTargetedName (never same player twice in a row, per user decision)
- Check if the summary string contains "Anomali:" followed by something other than "ingen"
- Extract the anomaly text after "Anomali: " and the tone text after "Ton: "

Collect all candidates. If none -> return null (no accusations when no anomalies, per user decision "if no behavioral anomalies, accusations are optional").

From candidates, pick one randomly (using `randomInt` from node:crypto, already imported pattern in the codebase). Return `{ name, anomalies, evidence }` where:
- `name` = player display name
- `anomalies` = the extracted anomaly string (e.g. "tystnat plotsligt")
- `evidence` = the tone string (e.g. "anklagande") for prompt context

Import `randomInt` from `node:crypto` (already used in whisper-handler.ts pattern).
  </action>
  <verify>Run `npx tsc --noEmit` -- no type errors. Grep for `computeGroupMood` and `selectAccusationTarget` exports in the file.</verify>
  <done>Both functions exported, GroupMood type exported. computeGroupMood returns one of three mood levels. selectAccusationTarget returns a target with anomaly evidence or null.</done>
</task>

<task type="auto">
  <name>Task 2: Mood-aware gap-fill prompt and accusation prompt builder</name>
  <files>src/lib/ai-prompts.ts</files>
  <action>
**1. Modify `buildGapFillPrompt` signature and content:**

Change signature to: `buildGapFillPrompt(gameContext: GuzmanContext, recentActivity: string, playerNames: string[], groupMood: string): string`

Add a new `groupMood` parameter (string to avoid importing the type -- keeps it simple). Update the prompt body:

Add a MOOD section after KONTEXT:
```
STAMNING I GRUPPEN: ${groupMood === "tense" ? "Spant -- folk anklagar varandra, misstanksamhet i luften" : groupMood === "calm" ? "Lugnt -- for lugnt. Ingen snackar, ingen ror sig." : "Aktivt -- folk diskuterar, men det saknas dramatik"}
```

Update UPPGIFT section to be ALWAYS provocative (per user decision "gap-fill commentary is always provocative regardless of current mood"):
- Replace current content options with: "Skriv en kort (1-3 meningar) provocerande kommentar. ALLTID provocerande -- oka spanningen oavsett stamning."
- Add mood-specific guidance:
  - If mood context mentions "Spant": "Gruppen ar redan pa kant -- hall bensin pa elden. Namn att nan beter sig konstigt utan att vara specifik."
  - If mood context mentions "Lugnt": "Det ar for tyst. Ifragasatt tystnaden. Varfor pratar ingen? Vad gommer dom?"
  - If mood context mentions "Aktivt": "Folk snackar men nan gommer sig. Droppa en mystisk observation."

Keep the existing rules: "Anvand BARA namnen som listas ovan. Hitta ALDRIG PA namn som inte finns i spelet." and character limit.

**2. Add `buildAccusationPrompt` function:**

```typescript
export function buildAccusationPrompt(
  targetName: string,
  anomalies: string,
  evidence: string,
  playerNames: string[],
  gameContext: GuzmanContext,
): string
```

Build a prompt for a public group chat accusation. Key constraints from user decisions:
- "Guzman only comments on actual observed behavior -- never fabricates suspicion or false accusations"
- "Accusations reference specific things players said or did -- concrete, chilling callouts"
- "Street boss intimidation -- direct, aggressive orten-slang"
- "Mix of direct @mentions and third-person references"
- Accusation prompt MUST NEVER receive player roles (critical pitfall from research)
- Max 2 accusations per round across ALL rounds (locked user decision -- no round-based escalation)

The prompt should:
- Include targetName, anomalies string, evidence/tone string, all playerNames, gameContext.mood
- Instruct Guzman to write 1-3 sentences of street boss intimidation calling out the target's behavior
- Randomly vary between @mention style ("Yo <b>{targetName}</b>, vad hander?") and third-person style ("Nan i familjen har blivit lite FOR tyst...") -- include instruction to pick one style
- Include the anomaly as context: map "tystnat plotsligt" -> "spelaren har blivit tyst", "aggressionsokning" -> "spelaren har borjat snacka aggressivt", "aktivitet sjunkit" -> "spelaren drar sig tillbaka", "beteendeforandring" -> "spelaren beter sig annorlunda"
- CRITICAL RULES: "ALDRIG avsloja roller. ALDRIG hitta pa beteenden som inte observerats. Basera ALLT pa den anomali som beskrivs."
- Max 400 tecken. Use HTML formatting.
- "Anvand BARA namnen som listas ovan."

Note: `roundNumber` parameter removed from signature -- frequency control is handled by the caller (canAccuse in Plan 02), not the prompt. Per locked decision: "Max 2 accusations per round" with no escalation curve.

Also add the discretion decisions:
- Mix 70% statement-drops and 30% provocation questions (research recommendation)
- Sometimes ask the group to react: "Vad tycker ni, bre?" (30% of time)
  </action>
  <verify>Run `npx tsc --noEmit` -- no type errors. Verify `buildAccusationPrompt` is exported. Verify `buildGapFillPrompt` now takes 4 parameters. Grep `buildAccusationPrompt` signature and verify no `PlayerRole` parameter or import of `PlayerRole` in ai-prompts.ts.</verify>
  <done>buildGapFillPrompt accepts groupMood parameter and produces always-provocative mood-adapted prompts. buildAccusationPrompt exported with street boss intimidation style, anomaly-based evidence, role-safe constraints, and no roundNumber parameter (frequency handled by caller).</done>
</task>

<task type="auto">
  <name>Task 3: generateAccusation function and mood-aware generateGapFillComment</name>
  <files>src/lib/ai-guzman.ts</files>
  <action>
**1. Update `generateGapFillComment` signature:**

Change signature to add `groupMood` parameter:
```typescript
export async function generateGapFillComment(
  gameContext: GuzmanContext,
  recentActivity: string,
  playerNames: string[],
  groupMood: string,
): Promise<string | null>
```

Pass `groupMood` through to `buildGapFillPrompt(gameContext, recentActivity, playerNames, groupMood)`.

**2. Add `generateAccusation` function:**

Add import for `buildAccusationPrompt` from `./ai-prompts.js`.

```typescript
export async function generateAccusation(
  targetName: string,
  anomalies: string,
  evidence: string,
  playerNames: string[],
  gameContext: GuzmanContext,
): Promise<string | null>
```

Note: No `roundNumber` parameter -- frequency control is the caller's responsibility, not the generator's. Per locked decision: consistent max 2 per round across ALL rounds.

Implementation follows existing pattern (see `generateGapFillComment`):
- Get AI client, return null if unavailable (CONST-04)
- Call `client.chat.completions.create` with:
  - `model: MODEL_MAP.commentary` (gpt-4.1-nano for cheap commentary)
  - system prompt: `buildGuzmanSystemPrompt()`
  - user prompt: `buildAccusationPrompt(targetName, anomalies, evidence, playerNames, gameContext)`
  - `max_tokens: 200` (accusations are short)
  - `temperature: 1.0` (variety in accusations)
- If content is null/empty, return null (NOT a template -- per research: "template accusations would violate 'never fabricates' decision")
- On any error, log warning and return null
- Sanitize with `sanitizeForTelegram()` before returning

IMPORTANT: Accusation fallback is null (skip), NOT a template. This is different from other AI functions. If AI fails, no accusation is sent -- this is correct per the "never fabricates" user decision.
  </action>
  <verify>Run `npx tsc --noEmit` -- no type errors. Grep for `generateAccusation` export. Verify it returns `Promise<string | null>` and uses MODEL_MAP.commentary.</verify>
  <done>generateAccusation exported, returns null on any failure (CONST-04 + never-fabricates). generateGapFillComment accepts groupMood parameter. Both use MODEL_MAP.commentary.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. `computeGroupMood`, `selectAccusationTarget`, `GroupMood` exported from behavioral-analysis.ts
3. `buildAccusationPrompt` exported from ai-prompts.ts
4. `buildGapFillPrompt` takes 4 parameters (groupMood added)
5. `generateAccusation` exported from ai-guzman.ts, returns null on failure
6. `generateGapFillComment` takes 4 parameters (groupMood added)
7. No player roles passed to accusation prompt (no PlayerRole import in ai-prompts.ts)
</verification>

<success_criteria>
All three modules compile. New functions are exported and ready for wiring in Plan 02. Accusation prompt enforces observed-behavior-only constraints. Gap-fill prompt is always provocative with mood-adapted content. Accusation generation falls back to null (not template).
</success_criteria>

<output>
After completion, create `.planning/phases/04-gap-fill-accusations/04-01-SUMMARY.md`
</output>
