---
phase: 05-mission-adaptation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/ai-prompts.ts
  - src/lib/ai-guzman.ts
  - src/handlers/game-loop.ts
autonomous: true

must_haves:
  truths:
    - "Mission narratives include behavioral commentary woven into the heist description"
    - "Group mood softly influences mission theme/vibe (not a hard mapping)"
    - "Player references mix named callouts and vague allusions"
    - "Round 1 missions work without behavioral data (graceful degradation)"
    - "AI failure falls back to existing template without dynamics (CONST-04)"
  artifacts:
    - path: "src/lib/ai-prompts.ts"
      provides: "Expanded buildMissionPrompt with groupDynamics and groupMood params"
      contains: "groupDynamics"
    - path: "src/lib/ai-guzman.ts"
      provides: "Expanded generateMissionNarrative with default params for backward compat"
      contains: "groupDynamics"
    - path: "src/handlers/game-loop.ts"
      provides: "Fresh analyzeBehavior call at 09:00 mission post time"
      contains: "analyzeBehavior"
  key_links:
    - from: "src/handlers/game-loop.ts"
      to: "src/lib/behavioral-analysis.ts"
      via: "analyzeBehavior() and computeGroupMood() import and call"
      pattern: "analyzeBehavior\\(game\\.id\\)"
    - from: "src/handlers/game-loop.ts"
      to: "src/lib/ai-guzman.ts"
      via: "generateMissionNarrative() with dynamics and mood args"
      pattern: "generateMissionNarrative.*groupDynamics.*groupMood"
    - from: "src/lib/ai-guzman.ts"
      to: "src/lib/ai-prompts.ts"
      via: "buildMissionPrompt() with dynamics and mood args"
      pattern: "buildMissionPrompt.*groupDynamics.*groupMood"
---

<objective>
Enrich mission narratives with group dynamics and mood-aware theming.

Purpose: Fulfill GROUP-04 -- mission posts reflect recent player behavior patterns, making each mission feel tailored to the current game atmosphere. Group mood softly biases mission theme (locked decision). Player references mix named callouts and vague allusions (locked decision).

Output: Modified prompt builder, AI generator, and game-loop handler -- missions now weave behavioral commentary into heist narratives.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/lib/ai-prompts.ts
@src/lib/ai-guzman.ts
@src/handlers/game-loop.ts
@src/lib/behavioral-analysis.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Expand buildMissionPrompt and generateMissionNarrative with behavioral data</name>
  <files>src/lib/ai-prompts.ts, src/lib/ai-guzman.ts</files>
  <action>
In `src/lib/ai-prompts.ts`, expand `buildMissionPrompt()` signature to accept two new parameters after `playerNames`:
- `groupDynamics: string` (compressed behavioral overview, may be empty string)
- `groupMood: string` (one of "tense" | "active" | "calm")

Add mood-to-theme guidance section (soft, not deterministic) inside the prompt:
- "tense" -> suggest betrayal/paranoia-themed heist vibe ("Gruppen är på kant -- låt uppdraget spegla misstro och förråd. Någon i teamet kanske inte är pålitlig.")
- "calm" -> suggest urgency/danger to shake things up ("Det är för lugnt -- skapa brådskligthet och fara. Gör stöten höginsats för att väcka gruppen.")
- "active" -> suggest complex multi-layered heist ("Gruppen är aktiv -- gör stöten komplex med flera lager. Testa deras samarbete.")

Add a conditional dynamics section (only when `groupDynamics` is non-empty) with these prompt instructions:
- Label: "GRUPPDYNAMIK (intern data -- väv in naturligt, ALDRIG visa som etiketter):"
- Include the groupDynamics string
- Instruction: "Väv in observationer om spelarna i uppdraget. Blanda namngivna utpekanden ('jag kollar på dig, bre') med vaga antydningar ('någon här beter sig skumt'). Guzman har märkt saker och kommenterar medan han beskriver stöten."

Add GRUPPDYNAMIK-REGLER section at the end of the prompt (after UPPGIFT):
- "Väv in beteendeobservationer NATURLIGT i narrativet (inte som en separat sektion)"
- "Blanda namngivna utpekanden med vaga antydningar"
- "Använd ALDRIG etiketter som 'Ton:', 'Aktivitet:', 'Anomali:' -- översätt till Guzmans orten-skvaller"
- "ALDRIG avslöja spelares roller"
- "Om det inte finns tillräckligt med beteendedata, fokusera på uppdraget -- tvinga inte in gruppdynamik"
- "70% av meddelandet ska vara uppdraget. 30% max ska vara gruppdynamik."

Add a "STÄMNING I GRUPPEN:" line with the groupMood value and the mood guidance.

IMPORTANT: All Swedish text MUST use proper åäö/ÅÄÖ characters. Never substitute with a/a/o.

In `src/lib/ai-guzman.ts`, expand `generateMissionNarrative()` signature with two new parameters after `playerNames`:
- `groupDynamics: string = ""` (default empty for backward compatibility)
- `groupMood: string = "active"` (default active for backward compatibility)

Pass these through to `buildMissionPrompt()`:
```
content: buildMissionPrompt(roundNumber, gameContext, playerNames, groupDynamics, groupMood),
```

The default params ensure any existing call sites (e.g., dev.ts if it exists) continue to work without changes.

Do NOT change max_tokens (stays 800) or temperature (stays 0.9). Do NOT change the model (stays MODEL_MAP.narrative). Do NOT change the template fallback behavior.
  </action>
  <verify>Run `npx tsc --noEmit` -- no type errors. Grep for "groupDynamics" in ai-prompts.ts and ai-guzman.ts to confirm params are wired through.</verify>
  <done>buildMissionPrompt accepts groupDynamics and groupMood and produces a prompt with mood guidance + dynamics section. generateMissionNarrative passes them through with backward-compatible defaults.</done>
</task>

<task type="auto">
  <name>Task 2: Wire fresh behavioral data gathering into onMissionPost</name>
  <files>src/handlers/game-loop.ts</files>
  <action>
In `src/handlers/game-loop.ts`, add imports at the top:
```
import { analyzeBehavior, computeGroupMood } from "../lib/behavioral-analysis.js";
```

In the `onMissionPost` handler, inside the try block that generates the mission narrative (around line 1538-1546), AFTER fetching `missionGuzmanCtx` and BEFORE calling `generateMissionNarrative()`, add fresh behavioral data gathering:

```typescript
// Fresh behavioral data for mission dynamics (non-critical, CONST-04)
let groupDynamics = "";
let groupMood = "active";
try {
  const { playerNotes } = await analyzeBehavior(game.id);
  groupMood = computeGroupMood(playerNotes);

  // Build compressed dynamics string for the prompt
  const dynamicsEntries: string[] = [];
  for (const [name, note] of Object.entries(playerNotes)) {
    if (note === "inaktiv") continue;
    dynamicsEntries.push(`${name}: ${note}`);
  }
  groupDynamics = dynamicsEntries.join("\n");
  // Hard-cap at 500 chars to respect CONST-02 token budget
  if (groupDynamics.length > 500) {
    groupDynamics = groupDynamics.slice(0, 497) + "...";
  }
} catch (err) {
  console.warn(
    "[game-loop] Fresh behavioral analysis for mission failed, using stale data:",
    err instanceof Error ? err.message : err,
  );
  // Fall back to empty dynamics (CONST-04) -- mission still generates fine
}
```

Then update the `generateMissionNarrative()` call to pass the new args:
```typescript
missionText = await generateMissionNarrative(
  round.round_number,
  missionGuzmanCtx,
  missionPlayerNames,
  groupDynamics,
  groupMood,
);
```

CRITICAL: The behavioral data gathering MUST be wrapped in its own try/catch separate from the outer try/catch. If analyzeBehavior fails, groupDynamics stays "" and groupMood stays "active" -- the mission generates without dynamics (graceful degradation per CONST-04).

Do NOT modify any other handler functions. Do NOT add analyzeBehavior calls to result reveal or any other handler.
  </action>
  <verify>Run `npx tsc --noEmit` -- no type errors. Grep for "analyzeBehavior" in game-loop.ts to confirm the import and call exist. Grep for "groupDynamics" in game-loop.ts to confirm variables are declared and passed to generateMissionNarrative.</verify>
  <done>onMissionPost gathers fresh behavioral data at 09:00, compresses it, and passes groupDynamics + groupMood to generateMissionNarrative. Failure falls back to empty dynamics without blocking the mission post.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. `buildMissionPrompt` in ai-prompts.ts accepts 5 params (roundNumber, gameContext, playerNames, groupDynamics, groupMood)
3. `generateMissionNarrative` in ai-guzman.ts accepts 5 params with defaults for backward compat
4. `onMissionPost` in game-loop.ts imports and calls `analyzeBehavior` and `computeGroupMood`
5. Behavioral data failure in game-loop.ts does NOT prevent mission posting (try/catch present)
6. No new npm dependencies added (CONST-01)
7. All Swedish text uses proper åäö characters
</verification>

<success_criteria>
- GROUP-04 implemented: mission narratives include group dynamics section reflecting player behavior
- Locked decision honored: group mood softly biases mission theme (not hard mapping)
- Locked decision honored: player references mix named callouts and vague allusions (prompt instruction)
- CONST-01 honored: zero new dependencies
- CONST-02 honored: dynamics data hard-capped at 500 chars (~300 tokens additional)
- CONST-03 honored: behavioral labels translated to natural Guzman voice (prompt rule)
- CONST-04 honored: analyzeBehavior failure does not block mission posting
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/05-mission-adaptation/05-01-SUMMARY.md`
</output>
