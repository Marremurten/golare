---
phase: 04-ai-guzman
plan: 03
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/handlers/whisper-handler.ts
  - src/handlers/game-loop.ts
  - src/lib/scheduler.ts
  - src/bot.ts
autonomous: true

must_haves:
  truths:
    - "Guzman sends private whisper DMs to 1-2 players per round on a schedule"
    - "Bonus whispers fire after significant game events (failed missions, close votes)"
    - "Whispers contain a mix of truth, half-truths, and outright lies"
    - "Whispers never explicitly reveal any player's role"
    - "Gap-fill commentary fires when group chat is quiet during active game hours"
    - "Whispers are disabled when AI is unavailable (no template whispers)"
    - "All whispers are persisted in the whispers table with truth_level tracking"
  artifacts:
    - path: "src/handlers/whisper-handler.ts"
      provides: "Whisper scheduling, event triggers, gap-fill commentary, group activity tracking"
      exports: ["createWhisperHandler", "triggerEventWhisper", "WhisperScheduleHandlers"]
    - path: "src/lib/scheduler.ts"
      provides: "Two new cron jobs for whisper scheduling (13:00, 19:00)"
      contains: "onWhisperAfternoon"
    - path: "src/bot.ts"
      provides: "Whisper handler wired into bot and scheduler"
      contains: "whisperHandler"
  key_links:
    - from: "src/handlers/whisper-handler.ts"
      to: "src/lib/ai-guzman.ts"
      via: "generateWhisperMessage and generateGapFillComment calls"
      pattern: "generateWhisperMessage|generateGapFillComment"
    - from: "src/handlers/whisper-handler.ts"
      to: "src/db/client.ts"
      via: "createWhisper for persistence, getWhispersForPlayerInRound for dedup"
      pattern: "createWhisper|getWhispersForPlayerInRound"
    - from: "src/handlers/game-loop.ts"
      to: "src/handlers/whisper-handler.ts"
      via: "triggerEventWhisper called after failed missions and close votes"
      pattern: "triggerEventWhisper"
    - from: "src/lib/scheduler.ts"
      to: "whisper-handler.ts"
      via: "cron jobs call whisper schedule handlers"
      pattern: "onWhisperAfternoon|onWhisperEvening"
---

<objective>
Implement Viskningar (manipulative whisper DMs) and gap-fill commentary.

Purpose: Whispers are the paranoia engine -- Guzman privately messages players with a mix of truths, half-truths, and lies about other players, creating social chaos when those messages get shared (or don't) in the group. Gap-fill keeps Guzman present during quiet periods between scheduled events. Both are AI-only features (disabled during fallback per discretion decision).

Output: New whisper-handler.ts module, updated scheduler with 2 whisper cron jobs, event triggers in game-loop.ts, group activity tracking for gap-fill
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-ai-guzman/04-CONTEXT.md
@.planning/phases/04-ai-guzman/04-RESEARCH.md
@.planning/phases/04-ai-guzman/04-01-SUMMARY.md
@src/handlers/game-loop.ts
@src/lib/scheduler.ts
@src/lib/ai-guzman.ts
@src/db/client.ts
@src/bot.ts
@src/queue/message-queue.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create whisper handler with scheduled whispers, event triggers, and gap-fill</name>
  <files>src/handlers/whisper-handler.ts</files>
  <action>
Create `src/handlers/whisper-handler.ts` as a new module. This is NOT a Composer (it doesn't handle Telegram callbacks). It exports functions called by the scheduler and game-loop event triggers.

**Group activity tracking (for gap-fill):**
- Module-level `Map<number, { count: number; lastReset: number }>` keyed by group_chat_id
- Track message count per group per hour window
- Export `trackGroupMessage(chatId: number)` -- increments counter, resets if >1 hour since lastReset
- Thresholds (per research): < 2 messages in 2 hours during 09:00-21:00 = "quiet" (trigger gap-fill). > 10 messages in 30 min = "heated" (trigger reaction). Start conservative.

**createWhisperHandler(bot: Bot)** -- Factory function that returns WhisperScheduleHandlers + triggerEventWhisper. Stores bot reference for DM sending.

**WhisperScheduleHandlers:**
- `onWhisperAfternoon()` -- Runs at 13:00. For each active game: select 1-2 random players who haven't been whispered this round. Generate whisper via `generateWhisperMessage()`. If AI returns null (unavailable), skip silently (per discretion: whispers disabled during fallback). If AI returns a whisper, send DM via `getMessageQueue().send(playerDmChatId, whisper.message, { parse_mode: "HTML" })` and persist via `createWhisper()`.
- `onWhisperEvening()` -- Runs at 19:00. Same logic as afternoon but different pool selection. May re-whisper a player who got an afternoon whisper if they're a "person of interest" (e.g., they were on the mission team, voted controversially).
- `onGapFill()` -- Runs at 14:00 and 20:00 (check activity). For each active game: check group activity tracker. If "quiet", generate gap-fill via `generateGapFillComment()`. If AI returns null, skip. If text returned, send to group. If "heated", also generate a reactive comment. These are sent to the GROUP chat, not DMs.

**Player selection for whispers:**
1. Get all players for the game via `getGamePlayersOrderedWithInfo(game.id)`
2. Get existing whispers for this round via `getWhispersForPlayerInRound()`
3. Filter to players not yet whispered (for baseline scheduled whispers)
4. Select 1-2 randomly using `Math.floor(Math.random() * ...)`
5. For each selected player, gather observable context:
   - Their voting history this game (from votes table -- add a helper if needed)
   - Whether they were on recent teams
   - Recent mission outcomes
   - NEVER include role information
6. Call `generateWhisperMessage(guzmanContext, playerName, otherPlayerNames, roundEvents)` -- no role parameter exists because the AI must never have access to role data

**triggerEventWhisper(gameId, event)** -- Called inline from game-loop.ts after specific events. Events:
- `"mission_failed"` -- After a mission fails, whisper 1 player about suspicion
- `"close_vote"` -- After a vote passes/fails with margin of 1, whisper 1 player about the vote
- `"kaos_triggered"` -- After kaos-mataren, whisper 1 player about the chaos
Fire-and-forget (don't await in game-loop -- use `.catch(err => console.warn(...))` to avoid blocking game flow).

**Whisper content guidelines (for the prompt context, not hardcoded):**
The AI generates the actual content, but the prompt should guide:
- Sometimes hint that others got whispers too: "och jag har sagt samma sak till alla" (dynamic per discretion)
- Sometimes keep it exclusive: "det har stannar mellan oss, bre"
- Never reveal actual roles
- Reference observable game events (votes, team selections, mission results)
  </action>
  <verify>
`npx tsc --noEmit` passes. `grep "createWhisperHandler\|triggerEventWhisper\|trackGroupMessage\|onWhisperAfternoon\|onWhisperEvening\|onGapFill" src/handlers/whisper-handler.ts` shows all expected exports/functions.
  </verify>
  <done>Whisper handler module with scheduled whisper delivery (1-2 players per round), event-triggered bonus whispers, gap-fill commentary based on group activity, and group message tracking. All AI-dependent (disabled during fallback). Whispers persisted in DB with truth_level.</done>
</task>

<task type="auto">
  <name>Task 2: Wire whisper handler into scheduler, game-loop, and bot.ts</name>
  <files>src/lib/scheduler.ts, src/handlers/game-loop.ts, src/bot.ts</files>
  <action>
**1. Update src/lib/scheduler.ts:**

Add whisper schedule handler types to `ScheduleHandlers`:
```typescript
export type ScheduleHandlers = {
  // ... existing 8 handlers ...
  onWhisperAfternoon: () => Promise<void>;
  onWhisperEvening: () => Promise<void>;
  onGapFill: () => Promise<void>;
};
```

Add 3 new cron jobs in `startScheduler()`:
```typescript
new Cron("0 13 * * 1-5", { timezone: TIMEZONE }, handlers.onWhisperAfternoon),
new Cron("0 19 * * 1-5", { timezone: TIMEZONE }, handlers.onWhisperEvening),
new Cron("0 14,20 * * 1-5", { timezone: TIMEZONE }, handlers.onGapFill),
```
Update the log message to say "Started 11 cron jobs".

Gap-fill runs at 14:00 and 20:00 -- these are mid-period times when the group might be quiet (between 12:00 nomination and 15:00 voting, and between 18:00 execution and 21:00 reveal).

**2. Update src/handlers/game-loop.ts:**

Import triggerEventWhisper from whisper-handler:
```typescript
import { triggerEventWhisper } from "./whisper-handler.js";
```

Add event trigger calls (fire-and-forget pattern):

After mission fail is determined in resolveExecution (~line where MISSION_FAIL is sent):
```typescript
triggerEventWhisper(game.id, "mission_failed").catch(err =>
  console.warn("[game-loop] Event whisper failed:", err)
);
```

After kaos-mataren is triggered (~line where KAOS_TRIGGERED is sent):
```typescript
triggerEventWhisper(game.id, "kaos_triggered").catch(err =>
  console.warn("[game-loop] Event whisper failed:", err)
);
```

After a close vote result (in handleVoteResult, when the margin between ja and nej counts is 1):
```typescript
if (Math.abs(result.jaCount - result.nejCount) <= 1) {
  triggerEventWhisper(game.id, "close_vote").catch(err =>
    console.warn("[game-loop] Event whisper failed:", err)
  );
}
```

Also, add group activity tracking for gap-fill. In the gameLoopHandler Composer (or a new middleware), listen for text messages in groups that have active games:
```typescript
// In gameLoopHandler Composer, add a middleware that fires for all group text messages:
gameLoopHandler.on("message:text", async (ctx, next) => {
  if (ctx.chat?.type === "group" || ctx.chat?.type === "supergroup") {
    trackGroupMessage(ctx.chat.id);
  }
  await next();
});
```
Import `trackGroupMessage` from whisper-handler. This middleware MUST call `next()` and be registered BEFORE any other handlers that might consume the update, or better: register it as a separate lightweight middleware that always passes through.

**3. Update src/bot.ts:**

Import createWhisperHandler:
```typescript
import { createWhisperHandler, trackGroupMessage } from "./handlers/whisper-handler.js";
```

After creating scheduleHandlers, create whisper handlers:
```typescript
const whisperHandlers = createWhisperHandler(bot);
```

Merge whisper handlers into scheduleHandlers object. The cleanest approach: have createScheduleHandlers accept whisper handlers as a parameter, OR create a combined handlers object:
```typescript
const combinedHandlers: ScheduleHandlers = {
  ...scheduleHandlers,
  onWhisperAfternoon: whisperHandlers.onWhisperAfternoon,
  onWhisperEvening: whisperHandlers.onWhisperEvening,
  onGapFill: whisperHandlers.onGapFill,
};
startScheduler(combinedHandlers);
```

Adjust the ordering so whisper handler is created before startScheduler is called. Move the `startScheduler(scheduleHandlers)` call to after whisper handler creation, passing the combined object.

Also register a lightweight middleware for group activity tracking before the existing handler registrations:
```typescript
bot.on("message:text", async (ctx, next) => {
  if (ctx.chat?.type === "group" || ctx.chat?.type === "supergroup") {
    trackGroupMessage(ctx.chat.id);
  }
  await next();
});
```
Register this BEFORE the other bot.use() calls so it catches all group messages.
  </action>
  <verify>
`npx tsc --noEmit` passes. `grep "onWhisperAfternoon\|onWhisperEvening\|onGapFill" src/lib/scheduler.ts` shows new handler types and cron jobs. `grep "triggerEventWhisper" src/handlers/game-loop.ts` shows event trigger calls. `grep "whisperHandler\|trackGroupMessage" src/bot.ts` shows wiring in bot.ts.
  </verify>
  <done>Scheduler has 3 new cron jobs (13:00, 19:00 whispers + 14:00/20:00 gap-fill). Game-loop fires event whispers after mission failures, kaos triggers, and close votes. Group message tracking middleware feeds gap-fill activity detection. All wired through bot.ts.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` -- full project compiles
2. Scheduler runs 11 cron jobs (8 original + 3 new)
3. Whisper handler generates and sends DMs via MessageQueue
4. Event triggers fire after mission_failed, kaos_triggered, close_vote
5. Group message tracking counts messages per group per hour
6. Gap-fill checks activity levels and sends commentary when group is quiet
7. All whisper generation respects the "no role in prompt" rule
8. Whispers are persisted in the whispers table
9. Everything degrades gracefully when AI is unavailable (no whispers, no gap-fill, game continues normally)
</verification>

<success_criteria>
- 1-2 players receive private whisper DMs per round at 13:00 and 19:00
- Bonus whispers fire after failed missions, kaos triggers, and close votes
- Whispers contain mix of truth/half-truths/lies (tracked in DB)
- Whispers never reveal actual player roles
- Gap-fill commentary fires when group is quiet between events
- All features disabled gracefully when OPENAI_API_KEY is not set
- Game loop is not blocked by whisper generation (fire-and-forget)
- Whispers persisted in whispers table for game history
</success_criteria>

<output>
After completion, create `.planning/phases/04-ai-guzman/04-03-SUMMARY.md`
</output>
